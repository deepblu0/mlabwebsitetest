<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giriş Yap | M-LAB Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        mlab: {
                            navy: '#0a192f',
                            cyan: '#00d4ff',
                            purple: '#7c3aed',
                            dark: '#0f172a',
                            orange: '#ff7e67',
                            teal: '#0d9488'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-gradient-to-br from-mlab-navy via-mlab-dark to-mlab-purple min-h-screen flex flex-col antialiased">

    <!-- Simple Header -->
    <header class="py-6">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <a href="index.html" class="inline-block">
                <img src="mlab-logo.png" alt="M-LAB" class="h-12 w-auto">
            </a>
        </div>
    </header>

    <!-- Login Form -->
    <section class="flex-grow flex items-center justify-center py-12 px-4">
        <div class="w-full max-w-md">
            <div class="bg-white rounded-3xl shadow-2xl p-8 lg:p-10">
                <!-- Header -->
                <div class="text-center mb-8">
                    <div
                        class="w-16 h-16 bg-gradient-to-br from-mlab-cyan to-mlab-purple rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="log-in" class="w-8 h-8 text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-mlab-navy mb-2">Portal'a Giriş</h1>
                    <p class="text-slate-500 text-sm">Hesabınıza giriş yapın</p>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">E-posta Adresi</label>
                        <div class="relative">
                            <i data-lucide="mail"
                                class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="email" name="email" required placeholder="ornek@kurum.gov.tr"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-12 pr-4 py-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Şifre</label>
                        <div class="relative">
                            <i data-lucide="lock"
                                class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="password" name="password" required placeholder="••••••••"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-12 pr-4 py-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all">
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="remember"
                                class="w-4 h-4 rounded border-slate-300 text-mlab-purple focus:ring-mlab-purple/50">
                            <span class="text-sm text-slate-600">Beni hatırla</span>
                        </label>
                        <a href="#" class="text-sm text-mlab-purple hover:underline font-medium">Şifremi unuttum</a>
                    </div>

                    <!-- Error Message -->
                    <div id="error-message"
                        class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-xl text-sm">
                        <i data-lucide="alert-circle" class="w-4 h-4 inline mr-2"></i>
                        <span id="error-text">Hatalı e-posta veya şifre.</span>
                    </div>

                    <!-- Pending Message -->
                    <div id="pending-message"
                        class="hidden bg-amber-50 border border-amber-200 text-amber-700 px-4 py-3 rounded-xl text-sm">
                        <i data-lucide="clock" class="w-4 h-4 inline mr-2"></i>
                        Hesabınız henüz onaylanmamış. Lütfen onay için bekleyin.
                    </div>

                    <button type="submit"
                        class="w-full bg-gradient-to-r from-mlab-navy to-mlab-purple text-white font-bold py-4 rounded-xl hover:shadow-xl hover:shadow-mlab-purple/20 transition-all duration-300 hover:-translate-y-0.5 flex items-center justify-center gap-2">
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        Giriş Yap
                    </button>
                </form>

                <div class="mt-8 pt-6 border-t border-slate-100 text-center">
                    <p class="text-sm text-slate-500">
                        Hesabınız yok mu?
                        <a href="portal-register.html" class="text-mlab-purple font-semibold hover:underline">Kayıt
                            Olun</a>
                    </p>
                </div>

                <!-- Demo Credentials -->
                <div class="mt-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <p class="text-xs text-slate-500 text-center mb-2">
                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                        Demo için örnek hesap:
                    </p>
                    <div class="text-xs text-slate-600 text-center font-mono">
                        demo@mlab.gov.tr / demo1234
                    </div>
                </div>
            </div>

            <div class="text-center mt-6">
                <a href="portal.html"
                    class="text-white/70 hover:text-white text-sm transition-colors inline-flex items-center gap-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    Portal'a Dön
                </a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-6 text-center">
        <p class="text-white/50 text-xs">&copy; 2025 M-LAB İzmir</p>
    </footer>

    <script src="firebase-config.js"></script>
    <script>
        lucide.createIcons();

        // Loading state
        let isSubmitting = false;

        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').classList.remove('hidden');
            document.getElementById('pending-message').classList.add('hidden');
            lucide.createIcons();
        }

        function showPending() {
            document.getElementById('error-message').classList.add('hidden');
            document.getElementById('pending-message').classList.remove('hidden');
            lucide.createIcons();
        }

        function hideMessages() {
            document.getElementById('error-message').classList.add('hidden');
            document.getElementById('pending-message').classList.add('hidden');
        }

        function setLoading(loading) {
            isSubmitting = loading;
            const btn = document.querySelector('button[type="submit"]');
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Giriş yapılıyor...';
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="arrow-right" class="w-5 h-5"></i> Giriş Yap';
            }
            lucide.createIcons();
        }

        // Initialize demo user for localStorage fallback
        if (!localStorage.getItem('portal_users')) {
            localStorage.setItem('portal_users', JSON.stringify([
                {
                    id: 1,
                    email: 'demo@mlab.gov.tr',
                    password: 'demo1234',
                    org_name: 'M-LAB Demo Hesabı',
                    category: 'belediye',
                    contact_name: 'Demo Kullanıcı',
                    status: 'approved'
                }
            ]));
        }

        document.getElementById('login-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            if (isSubmitting) return;

            const email = this.email.value;
            const password = this.password.value;

            hideMessages();
            setLoading(true);

            try {
                // Initialize Firebase
                const firebaseReady = await window.firebaseHelpers.initializeFirebase();

                if (!firebaseReady) {
                    // Fallback to localStorage
                    console.warn('Firebase yapılandırılmamış, localStorage kullanılıyor...');

                    const users = JSON.parse(localStorage.getItem('portal_users') || '[]');
                    const user = users.find(u => u.email === email && u.password === password);

                    if (user) {
                        localStorage.setItem('portal_current_user', JSON.stringify(user));
                        window.location.href = 'portal-dashboard.html';
                        return;
                    }

                    const pendingUsers = JSON.parse(localStorage.getItem('portal_pending_users') || '[]');
                    const pendingUser = pendingUsers.find(u => u.email === email && u.password === password);

                    if (pendingUser) {
                        showPending();
                        setLoading(false);
                        return;
                    }

                    showError('Hatalı e-posta veya şifre.');
                    setLoading(false);
                    return;
                }

                const { auth, signInWithEmailAndPassword } = window.firebaseAuth;
                const { db, doc, getDoc } = window.firebaseDb;

                // Sign in with Firebase
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Get user profile from Firestore
                const userDoc = await getDoc(doc(db, 'users', user.uid));

                if (!userDoc.exists()) {
                    showError('Kullanıcı profili bulunamadı.');
                    await window.firebaseAuth.signOut(auth);
                    setLoading(false);
                    return;
                }

                const userData = userDoc.data();

                // Check user status
                if (userData.status === 'pending') {
                    showPending();
                    await window.firebaseAuth.signOut(auth);
                    setLoading(false);
                    return;
                }

                if (userData.status === 'rejected') {
                    showError('Üyelik başvurunuz reddedilmiştir.');
                    await window.firebaseAuth.signOut(auth);
                    setLoading(false);
                    return;
                }

                if (userData.status !== 'approved') {
                    showError('Hesabınızda bir sorun var. Lütfen yönetici ile iletişime geçin.');
                    await window.firebaseAuth.signOut(auth);
                    setLoading(false);
                    return;
                }

                // Store user session for dashboard
                const sessionData = {
                    uid: user.uid,
                    email: user.email,
                    ...userData,
                    isAdmin: window.firebaseHelpers.isAdmin(user.email)
                };
                localStorage.setItem('portal_current_user', JSON.stringify(sessionData));

                // Redirect to dashboard
                window.location.href = 'portal-dashboard.html';

            } catch (error) {
                console.error('Giriş hatası:', error);

                let errorMessage = 'Giriş sırasında bir hata oluştu.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'Hatalı e-posta veya şifre.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Çok fazla başarısız deneme. Lütfen daha sonra tekrar deneyin.';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = 'Bu hesap devre dışı bırakılmış.';
                }

                showError(errorMessage);
            } finally {
                setLoading(false);
            }
        });
    </script>
</body>

</html>