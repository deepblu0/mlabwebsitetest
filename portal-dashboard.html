<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | M-LAB Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        mlab: {
                            navy: '#0a192f',
                            cyan: '#00d4ff',
                            purple: '#7c3aed',
                            dark: '#0f172a',
                            orange: '#ff7e67',
                            teal: '#0d9488'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .coin-flip-container {
            perspective: 1000px;
        }

        .coin-flip {
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }

        .coin-flip:hover {
            transform: rotateY(360deg);
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 antialiased min-h-screen">

    <!-- NAVBAR -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-mlab-navy text-white shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-6">
                    <a href="/" class="flex items-center gap-3">
                        <img src="mlab-logo.png" alt="M-LAB" class="h-10 w-auto brightness-0 invert">
                    </a>
                </div>

                <!-- Right Side: User Profile -->
                <div class="flex items-center gap-4 relative">
                    <button id="user-menu-btn" onclick="toggleUserMenu()"
                        class="flex items-center gap-3 hover:bg-white/10 px-3 py-2 rounded-xl transition-colors">
                        <div class="text-right hidden md:block">
                            <div class="text-sm font-semibold" id="user-name">Yükleniyor...</div>
                            <div class="text-xs text-white/70" id="user-role">Üye</div>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center border-2 border-white/20 overflow-hidden">
                            <img id="user-avatar" src="" alt="Profile" class="w-full h-full object-cover hidden">
                            <i data-lucide="user" id="default-user-icon" class="w-5 h-5 text-white"></i>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-white/70"></i>
                    </button>

                    <!-- Dropdown Menu -->
                    <div id="user-dropdown"
                        class="hidden absolute right-0 top-full mt-2 w-56 bg-white rounded-xl shadow-xl border border-slate-200 py-2 z-50">
                        <!-- Admin Link (Hidden by default) -->
                        <a href="portal-admin.html" id="admin-link"
                            class="hidden flex items-center gap-2 px-4 py-2 text-mlab-purple hover:bg-mlab-purple/5 text-sm font-semibold border-b border-slate-100">
                            <i data-lucide="shield-alert" class="w-4 h-4"></i>
                            Admin Paneli
                        </a>

                        <a href="portal"
                            class="flex items-center gap-2 px-4 py-2 text-slate-600 hover:bg-slate-50 text-sm">
                            <i data-lucide="home" class="w-4 h-4"></i>
                            Portal Ana Sayfa
                        </a>
                        <a href="portal-profile"
                            class="flex items-center gap-2 px-4 py-2 text-slate-600 hover:bg-slate-50 text-sm">
                            <i data-lucide="user-circle" class="w-4 h-4"></i>
                            Profil Ayarları
                        </a>
                        <hr class="my-2 border-slate-100">
                        <button onclick="logout()"
                            class="w-full flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-red-50 text-sm">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            Çıkış Yap
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </nav>

    <div class="h-16"></div>

    <!-- MAIN CONTENT -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Stats Bar -->
        <!-- Stats Bar (Hidden but space preserved for future content) -->
        <div
            class="mb-8 min-h-[100px] flex items-center justify-center border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50">
            <span class="text-slate-400 text-sm font-medium">Bu alan yeni içerikler için ayrılmıştır</span>
        </div>

        <!-- Filters & Content -->
        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Sidebar Filters -->
            <aside class="lg:w-64 flex-shrink-0">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 sticky top-24">
                    <h3 class="font-semibold text-mlab-navy mb-4 flex items-center gap-2">
                        <i data-lucide="filter" class="w-4 h-4"></i>
                        Filtreler
                    </h3>

                    <!-- Post Type Filter -->
                    <div class="mb-5">
                        <label class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-2 block">Post
                            Türü</label>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="post_type" value="all" checked
                                    class="w-4 h-4 text-mlab-purple focus:ring-mlab-purple/50">
                                <span class="text-sm text-slate-700">Tümü</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="post_type" value="destek_talebi"
                                    class="w-4 h-4 text-mlab-purple focus:ring-mlab-purple/50">
                                <span class="text-sm text-slate-700">Destek Talepleri</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="post_type" value="uzmanlik_sunumu"
                                    class="w-4 h-4 text-mlab-purple focus:ring-mlab-purple/50">
                                <span class="text-sm text-slate-700">Uzmanlık Bildirileri</span>
                            </label>
                        </div>
                    </div>

                    <!-- Category Filter -->
                    <div class="mb-5">
                        <label class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-2 block">Kurum
                            Türü</label>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="category" value="belediye" checked
                                    class="w-4 h-4 rounded text-mlab-purple focus:ring-mlab-purple/50">
                                <span class="text-sm text-slate-700">Belediye</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="category" value="ozel_sektor" checked
                                    class="w-4 h-4 rounded text-mlab-purple focus:ring-mlab-purple/50">
                                <span class="text-sm text-slate-700">Özel Sektör</span>
                            </label>
                        </div>
                    </div>

                    <!-- Büyük Zorluk Filter -->
                    <div>
                        <label class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-2 block">Büyük
                            Zorluk</label>
                        <select id="sector-filter"
                            class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50">
                            <option value="all">Tümü</option>
                            <option value="barinma">Uygun Fiyatlı Barınma</option>
                            <option value="hareketlilik">Sürdürülebilir Hareketlilik</option>
                            <option value="afet">Afetlere Dirençlilik</option>
                            <option value="gida">Sağlıklı Gıda</option>
                            <option value="saglik">Sağlık ve Esenlik</option>
                            <option value="egitim">Eğitimli Nesiller</option>
                            <option value="is">İnsana Yakışır İş</option>
                            <option value="inovasyon">İnovasyon Üretimi</option>
                            <option value="kultur">Kültür ve Kapsayıcılık</option>
                            <option value="dongusal">Döngüsel Metabolizma</option>
                        </select>
                    </div>

                    <button onclick="applyFilters()"
                        class="w-full mt-5 px-4 py-2 bg-mlab-navy text-white font-medium rounded-lg hover:bg-mlab-purple transition-colors text-sm">
                        Filtrele
                    </button>
                </div>

                <!-- Mobile New Post Button -->
                <button id="mobile-new-post-btn"
                    class="md:hidden w-full mt-4 flex items-center justify-center gap-2 px-4 py-3 bg-mlab-cyan text-mlab-navy font-semibold rounded-xl hover:bg-mlab-cyan/90 transition-colors">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    Yeni Çağrıda Bulun
                </button>
            </aside>

            <!-- Posts Grid -->
            <div class="flex-grow">
                <div id="posts-container" class="space-y-4">
                    <!-- Posts will be rendered here -->
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden text-center py-20">
                    <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="inbox" class="w-10 h-10 text-slate-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-600 mb-2">Henüz çağrı yok</h3>
                    <p class="text-slate-500 mb-6">İlk çağrıyı siz oluşturun!</p>
                    <button onclick="submitNewPost()" id="submit-btn"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-mlab-purple text-white font-semibold rounded-xl hover:bg-mlab-navy transition-colors">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        Yeni Çağrı
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- FLOATING ACTION BUTTONS -->
    <!-- FLOATING ACTION BUTTONS -->
    <div class="fixed bottom-6 right-6 z-40 flex flex-col gap-3 items-end">
        <!-- New Post Button (Top) -->
        <button id="new-post-btn" onclick="openNewPostModal()"
            class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-mlab-purple to-mlab-navy text-white text-xs font-semibold rounded-full shadow-lg shadow-mlab-purple/30 hover:shadow-mlab-purple/50 hover:scale-105 transition-all duration-300">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>Yeni Çağrı</span>
        </button>

        <!-- Expert Application Button (Bottom) -->
        <button id="expert-btn" onclick="openExpertModal()"
            class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-mlab-orange to-red-500 text-white text-xs font-semibold rounded-full shadow-lg shadow-mlab-orange/30 hover:shadow-mlab-orange/50 hover:scale-105 transition-all duration-300">
            <i data-lucide="clipboard-list" class="w-4 h-4"></i>
            <span>Uzman Havuzuna Katıl!</span>
        </button>
    </div>

    <!-- NEW POST MODAL -->
    <div id="new-post-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeNewPostModal()"></div>
        <div
            class="absolute inset-4 md:inset-10 lg:inset-y-10 lg:left-1/2 lg:-translate-x-1/2 lg:max-w-2xl lg:w-full bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-100 bg-slate-50">
                <h2 class="text-xl font-bold text-mlab-navy">Yeni Çağrıda Bulun</h2>
                <button onclick="closeNewPostModal()" class="p-2 hover:bg-slate-200 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="flex-grow overflow-y-auto p-6">
                <form id="new-post-form" class="space-y-5">
                    <!-- Expert Support Call-to-Action -->
                    <div
                        class="bg-gradient-to-r from-mlab-orange/10 to-transparent p-4 rounded-xl border border-mlab-orange/20 mb-6">
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-lg bg-gradient-to-br from-mlab-orange to-amber-500 flex items-center justify-center shrink-0">
                                    <i data-lucide="award" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 text-sm">Uzman mısınız?</h3>
                                    <p class="text-xs text-slate-500">Çözüm ağımıza katılın</p>
                                </div>
                            </div>
                            <button type="button" onclick="closeNewPostModal(); openExpertModal();"
                                class="px-4 py-2 bg-gradient-to-r from-mlab-orange to-amber-500 text-white text-xs font-bold rounded-lg hover:shadow-lg transition-transform hover:-translate-y-0.5 whitespace-nowrap">
                                Beni Uzman Havuzuna Dahil Et!
                            </button>
                        </div>
                    </div>

                    <!-- Post Type -->
                    <div>
                        <label class="block text-sm font-semibold text-mlab-navy mb-3">Çağrı Türü *</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="relative cursor-pointer">
                                <input type="radio" name="post_type" value="destek_talebi" class="peer sr-only"
                                    required>
                                <div
                                    class="p-4 rounded-xl border-2 border-slate-200 peer-checked:border-mlab-cyan peer-checked:bg-mlab-cyan/5 transition-all hover:border-slate-300 h-full flex flex-col">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div
                                            class="w-10 h-10 rounded-full bg-gradient-to-br from-mlab-cyan to-teal-500 flex items-center justify-center shadow-lg shadow-mlab-cyan/30 shrink-0">
                                            <i data-lucide="message-square-plus" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div class="font-semibold text-mlab-navy text-sm">Destek Talebi</div>
                                    </div>
                                    <p class="text-xs text-slate-500 leading-relaxed">
                                        İnovatif, yaşanabilir ve iklim nötr odaklı projeleriniz için ihtiyaç duyduğunuz
                                        partner, finansman veya teknik altyapı desteğini buradan duyurun.
                                    </p>
                                </div>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" name="post_type" value="uzmanlik_sunumu" class="peer sr-only"
                                    required>
                                <div
                                    class="p-4 rounded-xl border-2 border-slate-200 peer-checked:border-mlab-orange peer-checked:bg-mlab-orange/5 transition-all hover:border-slate-300 h-full flex flex-col">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div
                                            class="w-10 h-10 rounded-full bg-gradient-to-br from-mlab-orange to-amber-500 flex items-center justify-center shadow-lg shadow-mlab-orange/30 shrink-0">
                                            <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div class="font-semibold text-mlab-navy text-sm">Uzmanlık Bildirisi</div>
                                    </div>
                                    <p class="text-xs text-slate-500 leading-relaxed">
                                        Şehrin dönüşüm hedeflerine değer katacak kurumsal yetkinliklerinizi, akademik
                                        birikiminizi veya teknolojik çözüm önerilerinizi çözüm ağına ekleyin.
                                    </p>
                                </div>
                            </label>
                        </div>
                    </div>


                    <!-- Title -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Başlık *</label>
                        <input type="text" name="title" required
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all">
                    </div>

                    <!-- Büyük Zorluk -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Büyük Zorluk *</label>
                        <select name="sector" required
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all">
                            <option value="">Seçiniz...</option>
                            <option value="barinma">Uygun Fiyatlı Barınma</option>
                            <option value="hareketlilik">Sürdürülebilir Hareketlilik</option>
                            <option value="afet">Afetlere Dirençlilik</option>
                            <option value="gida">Sağlıklı Gıda</option>
                            <option value="saglik">Sağlık ve Esenlik</option>
                            <option value="egitim">Eğitimli Nesiller</option>
                            <option value="is">İnsana Yakışır İş</option>
                            <option value="inovasyon">İnovasyon Üretimi</option>
                            <option value="kultur">Kültür ve Kapsayıcılık</option>
                            <option value="dongusal">Döngüsel Metabolizma</option>
                        </select>
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Açıklama *</label>
                        <textarea name="description" rows="4" required
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all resize-none"></textarea>
                    </div>

                    <!-- File Upload -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            <i data-lucide="paperclip" class="w-4 h-4 inline mr-1"></i>
                            Dosya Ekle (opsiyonel)
                        </label>
                        <div id="file-drop-zone"
                            class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center hover:border-mlab-purple transition-colors cursor-pointer bg-slate-50">
                            <input type="file" id="post-file" name="file"
                                accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif" class="hidden"
                                onchange="handleFileSelect(event)">
                            <label for="post-file" class="cursor-pointer">
                                <i data-lucide="upload-cloud" class="w-8 h-8 mx-auto text-slate-400 mb-2"></i>
                                <p class="text-sm text-slate-600">Dosya seçin veya sürükleyin</p>
                                <p class="text-xs text-slate-400 mt-1">PDF, Word, Excel, Resim (max 10MB)</p>
                            </label>
                        </div>
                        <div id="selected-file-display" class="mt-2 hidden">
                            <div
                                class="flex items-center justify-between bg-white border border-slate-200 rounded-lg px-3 py-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="file" id="selected-file-icon" class="w-4 h-4 text-mlab-purple"></i>
                                    <span id="selected-file-name"
                                        class="text-sm text-slate-700 truncate max-w-[200px]"></span>
                                    <span id="selected-file-size" class="text-xs text-slate-400"></span>
                                </div>
                                <button type="button" onclick="removeSelectedFile()"
                                    class="p-1 hover:bg-red-50 rounded text-red-500">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="closeNewPostModal()"
                    class="px-5 py-2.5 text-slate-600 font-medium rounded-xl hover:bg-slate-200 transition-colors">
                    İptal
                </button>
                <button onclick="submitNewPost()" id="submit-btn"
                    class="inline-flex items-center gap-2 px-6 py-3 bg-mlab-purple text-white font-semibold rounded-xl hover:bg-mlab-navy transition-colors">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    Yeni Çağrı
                </button>
            </div>
        </div>
    </div>

    <!-- EXPERT APPLICATION MODAL -->
    <div id="expert-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeExpertModal()"></div>
        <div
            class="absolute inset-4 md:inset-10 lg:inset-y-10 lg:left-1/2 lg:-translate-x-1/2 lg:max-w-3xl lg:w-full bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-mlab-navy to-mlab-purple p-6 flex items-center justify-between shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center">
                        <i data-lucide="clipboard-list" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-white">Uzman Başvuru Formu</h2>
                        <p class="text-white/70 text-sm">Tüm alanları eksiksiz doldurunuz.</p>
                    </div>
                </div>
                <button onclick="closeExpertModal()" class="text-white/70 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="flex-grow overflow-y-auto p-6 md:p-8">
                <form id="expert-form" class="space-y-8">
                    <!-- Kişisel Bilgiler -->
                    <div>
                        <h3 class="text-lg font-bold text-mlab-navy mb-4 flex items-center gap-2">
                            <span
                                class="w-8 h-8 bg-mlab-cyan/10 rounded-lg flex items-center justify-center text-mlab-cyan text-sm font-bold">1</span>
                            Kişisel Bilgiler
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Ad Soyad *</label>
                                <input type="text" name="fullName" required
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-mlab-cyan focus:ring-2 focus:ring-mlab-cyan/20 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Meslek *</label>
                                <input type="text" name="profession" required
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-mlab-cyan focus:ring-2 focus:ring-mlab-cyan/20 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Çalıştığı Kurum
                                    *</label>
                                <input type="text" name="organization" required
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-mlab-cyan focus:ring-2 focus:ring-mlab-cyan/20 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Ünvan *</label>
                                <input type="text" name="title" required
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-mlab-cyan focus:ring-2 focus:ring-mlab-cyan/20 outline-none transition-all">
                            </div>
                        </div>
                    </div>

                    <!-- İletişim Bilgileri -->
                    <div>
                        <h3 class="text-lg font-bold text-mlab-navy mb-4 flex items-center gap-2">
                            <span
                                class="w-8 h-8 bg-mlab-cyan/10 rounded-lg flex items-center justify-center text-mlab-cyan text-sm font-bold">2</span>
                            İletişim Bilgileri
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">E-posta Adresi
                                    *</label>
                                <input type="email" name="email" required
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-mlab-cyan focus:ring-2 focus:ring-mlab-cyan/20 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Telefon Numarası
                                    *</label>
                                <input type="tel" name="phone" required
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-mlab-cyan focus:ring-2 focus:ring-mlab-cyan/20 outline-none transition-all">
                            </div>
                        </div>
                    </div>

                    <!-- Uzmanlık Bilgileri -->
                    <div>
                        <h3 class="text-lg font-bold text-mlab-navy mb-4 flex items-center gap-2">
                            <span
                                class="w-8 h-8 bg-mlab-cyan/10 rounded-lg flex items-center justify-center text-mlab-cyan text-sm font-bold">3</span>
                            Uzmanlık Bilgileri
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Uzmanlık Alanı
                                    *</label>
                                <input type="text" name="expertiseArea" required
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-mlab-cyan focus:ring-2 focus:ring-mlab-cyan/20 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Uzmanlık Detayları
                                    *</label>
                                <textarea name="expertiseDetails" required rows="4"
                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-mlab-cyan focus:ring-2 focus:ring-mlab-cyan/20 outline-none transition-all resize-none"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Eğitim Bilgileri -->
                    <div>
                        <h3 class="text-lg font-bold text-mlab-navy mb-4 flex items-center gap-2">
                            <span
                                class="w-8 h-8 bg-mlab-cyan/10 rounded-lg flex items-center justify-center text-mlab-cyan text-sm font-bold">4</span>
                            Eğitim Bilgileri
                        </h3>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Eğitim Geçmişi *</label>
                            <textarea name="education" required rows="3"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-mlab-cyan focus:ring-2 focus:ring-mlab-cyan/20 outline-none transition-all resize-none"></textarea>
                        </div>
                    </div>

                    <!-- Etik Taahhüt -->
                    <div class="bg-slate-50 rounded-xl p-6 border border-slate-200">
                        <h3 class="text-lg font-bold text-mlab-navy mb-4 flex items-center gap-2">
                            <span
                                class="w-8 h-8 bg-mlab-purple/10 rounded-lg flex items-center justify-center text-mlab-purple text-sm font-bold">5</span>
                            Etik Taahhütname
                        </h3>
                        <div class="flex items-start gap-3">
                            <input type="checkbox" id="coc-checkbox" name="cocAccepted"
                                class="mt-1.5 w-5 h-5 rounded border-slate-300 text-mlab-purple focus:ring-mlab-purple cursor-pointer"
                                disabled>
                            <div>
                                <label for="coc-checkbox" class="text-sm text-slate-700 cursor-pointer">
                                    <span class="font-medium">Çıkar Çatışması ve Gizlilik Taahhütnamesini</span>
                                    okudum ve kabul ediyorum.
                                </label>
                                <button type="button" onclick="openCocModal()"
                                    class="block mt-2 text-sm text-mlab-purple hover:text-mlab-navy font-medium underline underline-offset-2">
                                    <i data-lucide="file-text" class="w-4 h-4 inline-block mr-1"></i>
                                    Taahhütnameyi Oku (Zorunlu)
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3 shrink-0">
                <button onclick="closeExpertModal()"
                    class="px-5 py-2.5 text-slate-600 font-medium rounded-xl hover:bg-slate-200 transition-colors">
                    İptal
                </button>
                <button type="submit" form="expert-form" id="expert-submit-btn" disabled
                    class="px-6 py-2.5 bg-gradient-to-r from-mlab-navy to-mlab-purple text-white font-bold rounded-xl hover:shadow-lg hover:shadow-mlab-purple/25 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    Başvuruyu Gönder
                </button>
            </div>
        </div>
    </div>

    <!-- CODE OF CONDUCT MODAL -->
    <div id="coc-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCocModal()"></div>
        <div
            class="absolute inset-x-4 top-1/2 -translate-y-1/2 md:max-w-2xl md:mx-auto bg-white rounded-2xl shadow-2xl max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div
                class="bg-gradient-to-r from-mlab-navy to-mlab-purple p-6 rounded-t-2xl flex items-center justify-between shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                        <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white">Çıkar Çatışması ve Gizlilik Taahhütnamesi</h3>
                        <p class="text-white/70 text-sm">Lütfen sonuna kadar okuyunuz</p>
                    </div>
                </div>
                <button onclick="closeCocModal()" class="text-white/70 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="p-6 overflow-y-auto flex-grow">
                <div class="prose prose-slate max-w-none text-sm">
                    <h4 class="text-mlab-navy font-bold text-lg mb-4">Etik Beyan</h4>
                    <p class="text-slate-600 mb-6">
                        İzmir Büyükşehir Belediyesi çalışmalarında bağımsız uzman olarak görev almak üzere başvuruda
                        bulunuyorum. Bu kapsamda aşağıdaki hususları beyan ederim:
                    </p>
                    <div class="space-y-4 text-slate-600">
                        <p><strong>1. Çıkar Çatışması:</strong> Danışmanlık veya değerlendirme desteği verdiğim
                            konularda ihale, proje veya hibe süreçlerine katılmayacağım. Yakınlarımın dahil olduğu
                            süreçlerden çekileceğim.</p>
                        <p><strong>2. Gizlilik:</strong> Görevim sırasında edindiğim bilgileri gizli tutacağım ve
                            üçüncü
                            kişilerle paylaşmayacağım.</p>
                        <p><strong>3. Tarafsızlık:</strong> Değerlendirmelerimi objektif kriterlere göre yapacağım.
                        </p>
                    </div>
                    <div class="bg-slate-100 rounded-xl p-4 mt-6">
                        <p class="text-slate-600 text-sm">
                            Bu formu göndererek yukarıdaki beyanları kabul etmiş sayılırım.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 border-t border-slate-200 bg-slate-50 rounded-b-2xl shrink-0">
                <div class="flex flex-col sm:flex-row gap-3">
                    <button onclick="closeCocModal()" type="button"
                        class="flex-1 py-3 px-6 border border-slate-300 text-slate-700 font-medium rounded-xl hover:bg-slate-100 transition-all">
                        Kabul Etmiyorum
                    </button>
                    <button onclick="acceptCoc()" type="button"
                        class="flex-1 py-3 px-6 bg-gradient-to-r from-mlab-navy to-mlab-purple text-white font-bold rounded-xl hover:shadow-lg transition-all flex items-center justify-center gap-2">
                        <i data-lucide="check" class="w-5 h-5"></i>
                        Okudum ve Kabul Ediyorum
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>
    </main>


    <!-- NEW POST MODAL -->
    <div id="new-post-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeNewPostModal()"></div>
        <div
            class="absolute inset-4 md:inset-10 lg:inset-y-10 lg:left-1/2 lg:-translate-x-1/2 lg:max-w-2xl lg:w-full bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-100 bg-slate-50">
                <h2 class="text-xl font-bold text-mlab-navy">Yeni Çağrıda Bulun</h2>
                <button onclick="closeNewPostModal()" class="p-2 hover:bg-slate-200 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="flex-grow overflow-y-auto p-6">
                <form id="new-post-form" class="space-y-5">
                    <!-- Post Type -->
                    <div>
                        <label class="block text-sm font-semibold text-mlab-navy mb-3">Çağrı Türü *</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="relative cursor-pointer">
                                <input type="radio" name="post_type" value="destek_talebi" class="peer sr-only"
                                    required>
                                <div
                                    class="p-4 rounded-xl border-2 border-slate-200 peer-checked:border-mlab-cyan peer-checked:bg-mlab-cyan/5 transition-all hover:border-slate-300 h-full flex flex-col">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div
                                            class="w-10 h-10 rounded-full bg-gradient-to-br from-mlab-cyan to-teal-500 flex items-center justify-center shadow-lg shadow-mlab-cyan/30 shrink-0">
                                            <i data-lucide="message-square-plus" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div class="font-semibold text-mlab-navy text-sm">Destek Talebi</div>
                                    </div>
                                    <p class="text-xs text-slate-500 leading-relaxed">
                                        İnovatif, yaşanabilir ve iklim nötr odaklı projeleriniz için ihtiyaç duyduğunuz
                                        partner, finansman veya teknik altyapı
                                        desteğini buradan duyurun.
                                    </p>
                                </div>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" name="post_type" value="uzmanlik_sunumu" class="peer sr-only"
                                    required>
                                <div
                                    class="p-4 rounded-xl border-2 border-slate-200 peer-checked:border-mlab-orange peer-checked:bg-mlab-orange/5 transition-all hover:border-slate-300 h-full flex flex-col">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div
                                            class="w-10 h-10 rounded-full bg-gradient-to-br from-mlab-orange to-amber-500 flex items-center justify-center shadow-lg shadow-mlab-orange/30 shrink-0">
                                            <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div class="font-semibold text-mlab-navy text-sm">Uzmanlık Bildirisi</div>
                                    </div>
                                    <p class="text-xs text-slate-500 leading-relaxed">
                                        Şehrin dönüşüm hedeflerine değer katacak kurumsal yetkinliklerinizi, akademik
                                        birikiminizi veya teknolojik çözüm
                                        önerilerinizi çözüm ağına ekleyin.
                                    </p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Title -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Başlık *</label>
                        <input type="text" name="title" required
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all">
                    </div>

                    <!-- Büyük Zorluk -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Büyük Zorluk *</label>
                        <select name="sector" required
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all">
                            <option value="">Seçiniz...</option>
                            <option value="barinma">Uygun Fiyatlı Barınma</option>
                            <option value="hareketlilik">Sürdürülebilir Hareketlilik</option>
                            <option value="afet">Afetlere Dirençlilik</option>
                            <option value="gida">Sağlıklı Gıda</option>
                            <option value="saglik">Sağlık ve Esenlik</option>
                            <option value="egitim">Eğitimli Nesiller</option>
                            <option value="is">İnsana Yakışır İş</option>
                            <option value="inovasyon">İnovasyon Üretimi</option>
                            <option value="kultur">Kültür ve Kapsayıcılık</option>
                            <option value="dongusal">Döngüsel Metabolizma</option>
                        </select>
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Açıklama *</label>
                        <textarea name="description" rows="4" required
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all resize-none"></textarea>
                    </div>

                    <!-- File Upload -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            <i data-lucide="paperclip" class="w-4 h-4 inline mr-1"></i>
                            Dosya Ekle (opsiyonel)
                        </label>
                        <div id="file-drop-zone"
                            class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center hover:border-mlab-purple transition-colors cursor-pointer bg-slate-50">
                            <input type="file" id="post-file" name="file"
                                accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif" class="hidden"
                                onchange="handleFileSelect(event)">
                            <label for="post-file" class="cursor-pointer">
                                <i data-lucide="upload-cloud" class="w-8 h-8 mx-auto text-slate-400 mb-2"></i>
                                <p class="text-sm text-slate-600">Dosya seçin veya sürükleyin</p>
                                <p class="text-xs text-slate-400 mt-1">PDF, Word, Excel, Resim (max 10MB)</p>
                            </label>
                        </div>
                        <div id="selected-file-display" class="mt-2 hidden">
                            <div
                                class="flex items-center justify-between bg-white border border-slate-200 rounded-lg px-3 py-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="file" id="selected-file-icon" class="w-4 h-4 text-mlab-purple"></i>
                                    <span id="selected-file-name"
                                        class="text-sm text-slate-700 truncate max-w-[200px]"></span>
                                    <span id="selected-file-size" class="text-xs text-slate-400"></span>
                                </div>
                                <button type="button" onclick="removeSelectedFile()"
                                    class="p-1 hover:bg-red-50 rounded text-red-500">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="closeNewPostModal()"
                    class="px-5 py-2.5 text-slate-600 font-medium rounded-xl hover:bg-slate-200 transition-colors">
                    İptal
                </button>
                <button onclick="submitNewPost()"
                    class="px-5 py-2.5 bg-gradient-to-r from-mlab-navy to-mlab-purple text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                    Yayınla
                </button>
            </div>
        </div>
    </div>

    <!-- POST DETAIL MODAL -->
    <div id="post-detail-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closePostDetailModal()"></div>
        <div
            class="absolute inset-4 md:inset-10 lg:inset-y-10 lg:left-1/2 lg:-translate-x-1/2 lg:max-w-2xl lg:w-full bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-100 bg-slate-50">
                <h2 id="detail-title" class="text-xl font-bold text-mlab-navy">Post Detayı</h2>
                <button onclick="closePostDetailModal()" class="p-2 hover:bg-slate-200 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                </button>
            </div>
            <div id="detail-content" class="flex-grow overflow-y-auto p-6">
                <!-- Content will be rendered here -->
            </div>
        </div>
    </div>

    <!-- USER PROFILE MODAL -->
    <div id="user-profile-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeUserProfileModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden">
            <div
                class="flex items-center justify-between px-6 py-4 border-b border-slate-100 bg-gradient-to-r from-mlab-navy to-mlab-purple">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="user-circle" class="w-5 h-5"></i>
                    Üye Profili
                </h2>
                <button onclick="closeUserProfileModal()" class="p-2 hover:bg-white/20 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-white"></i>
                </button>
            </div>
            <div id="user-profile-content" class="p-6">
                <!-- User profile will be rendered here -->
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        lucide.createIcons();

        let currentUser = null;
        let allPosts = [];
        let selectedFile = null; // Single file for post upload

        // File handling functions
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFilesToList(files);
        }

        // Single file handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert('Dosya çok büyük. Maksimum 10MB olmalı.');
                event.target.value = '';
                return;
            }

            selectedFile = file;
            showSelectedFile(file);
        }

        function showSelectedFile(file) {
            const display = document.getElementById('selected-file-display');
            const nameEl = document.getElementById('selected-file-name');
            const sizeEl = document.getElementById('selected-file-size');

            if (!display || !nameEl || !sizeEl) return;

            nameEl.textContent = file.name;
            sizeEl.textContent = '(' + formatFileSize(file.size) + ')';
            display.classList.remove('hidden');
            lucide.createIcons();
        }

        function removeSelectedFile() {
            selectedFile = null;
            const fileInput = document.getElementById('post-file');
            if (fileInput) fileInput.value = '';
            const display = document.getElementById('selected-file-display');
            if (display) display.classList.add('hidden');
        }

        // Comment file handling
        let commentFiles = {}; // Store files by postId

        function handleCommentFileSelect(event, postId) {
            const file = event.target.files[0];
            if (!file) return;

            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert('Dosya çok büyük. Maksimum 10MB olmalı.');
                event.target.value = '';
                return;
            }

            commentFiles[postId] = file;
            const display = document.getElementById(`comment-file-display-${postId}`);
            const nameEl = document.getElementById(`comment-file-name-${postId}`);
            if (display && nameEl) {
                nameEl.textContent = file.name;
                display.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        function removeCommentFile(postId) {
            delete commentFiles[postId];
            const fileInput = document.getElementById(`comment-file-${postId}`);
            if (fileInput) fileInput.value = '';
            const display = document.getElementById(`comment-file-display-${postId}`);
            if (display) display.classList.add('hidden');
        }

        function getFileIcon(mimeType) {
            if (mimeType.includes('pdf')) return 'file-text';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'file-text';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'file-spreadsheet';
            if (mimeType.includes('image')) return 'image';
            return 'file';
        }

        // Used for post card file display  
        function getFileIconType(mimeType) {
            if (!mimeType) return 'file';
            if (mimeType.includes('pdf')) return 'file-text';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'file-text';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'file-spreadsheet';
            if (mimeType.includes('image')) return 'image';
            return 'file';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B'; if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'; return
            (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        } async function uploadFiles(postId) {
            if
                (selectedFiles.length === 0) return []; const { storage, ref, uploadBytes, getDownloadURL
                } = window.firebaseStorage; const uploadedFiles = []; for (const file of selectedFiles) {
                    const
                        fileName = `${Date.now()}_${file.name}`; const storageRef = ref(storage, `posts/${postId}/${fileName}`); await
                            uploadBytes(storageRef, file); const url = await getDownloadURL(storageRef); uploadedFiles.push({
                                name: file.name,
                                url: url, size: file.size, type: file.type
                            });
                } return uploadedFiles;
        } // Setup drag and drop
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('file-drop-zone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('border-mlab-purple', 'bg-mlab-purple/5');
                });

                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-mlab-purple', 'bg-mlab-purple/5');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-mlab-purple', 'bg-mlab-purple/5');
                    const files = Array.from(e.dataTransfer.files);
                    addFilesToList(files);
                });
            }
        });

        // Check authentication
        async function checkAuth() {
            currentUser = JSON.parse(localStorage.getItem('portal_current_user'));
            if (!currentUser) {
                window.location.href = 'portal-login.html';
                return false;
            }
            document.getElementById('user-name').textContent = currentUser.contact_name || currentUser.org_name;

            // Add admin link if user is admin
            const isAdmin = window.ADMIN_EMAILS?.includes(currentUser.email?.toLowerCase()) || currentUser.isAdmin;
            if (isAdmin) {
                const adminLink = document.getElementById('admin-link');
                if (adminLink) {
                    adminLink.classList.remove('hidden');
                    adminLink.classList.add('flex');
                }
            }

            // Update user role display
            const roleEl = document.getElementById('user-role');
            if (roleEl) {
                if (isAdmin) roleEl.textContent = 'Yönetici';
                else if (currentUser.org_type) roleEl.textContent = currentUser.org_type === 'belediye' ? 'Belediye' : 'Özel Sektör';
                else roleEl.textContent = 'Üye';
            }
            lucide.createIcons();
            return true;
        }

        // User Menu Logic
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) dropdown.classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const btn = document.getElementById('user-menu-btn');
            const dropdown = document.getElementById('user-dropdown');
            if (btn && dropdown && !btn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        async function logout() {
            try {
                const firebaseReady = await window.firebaseHelpers.initializeFirebase();
                if (firebaseReady) {
                    await window.firebaseAuth.signOut(window.firebaseAuth.auth);
                }
            } catch (e) { }

            localStorage.removeItem('portal_current_user');
            window.location.href = 'portal-login.html';
        }

        // User Profile Popup Functions
        function showUserProfile(authorId, authorData) {
            const modal = document.getElementById('user-profile-modal');
            const content = document.getElementById('user-profile-content');

            if (!authorData) {
                content.innerHTML = '<p class="text-slate-500 text-center">Kullanıcı bilgisi bulunamadı.</p>';
                modal.classList.remove('hidden');
                lucide.createIcons();
                return;
            }

            const categoryIcon = authorData.category === 'belediye' ? 'landmark' : 'building-2';
            const categoryColor = authorData.category === 'belediye' ? 'mlab-navy' : 'mlab-orange';
            const categoryLabel = authorData.category === 'belediye' ? 'Belediye' : 'Özel Sektör';

            content.innerHTML = `
                <div class="space-y-4">
                    <!-- Header -->
                    <div class="flex items-center gap-4 pb-4 border-b border-slate-100">
                        <div class="w-14 h-14 rounded-2xl bg-${categoryColor}/10 flex items-center justify-center">
                            <i data-lucide="${categoryIcon}" class="w-7 h-7 text-${categoryColor}"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-mlab-navy">${authorData.name || 'Bilinmiyor'}</h3>
                            <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-${categoryColor}/10 text-${categoryColor}">${categoryLabel}</span>
                        </div>
                    </div>

                    <!-- Contact Person -->
                    ${authorData.contact_name ? `
                    <div class="flex items-center gap-3">
                        <i data-lucide="user" class="w-4 h-4 text-slate-400"></i>
                        <div>
                            <div class="text-xs text-slate-400">İletişim Kişisi</div>
                            <div class="text-sm font-medium text-slate-700">${authorData.contact_name}${authorData.contact_title ? ' - ' + authorData.contact_title : ''}</div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Email -->
                    ${authorData.email ? `
                    <div class="flex items-center gap-3">
                        <i data-lucide="mail" class="w-4 h-4 text-slate-400"></i>
                        <div>
                            <div class="text-xs text-slate-400">E-posta</div>
                            <a href="mailto:${authorData.email}" class="text-sm font-medium text-mlab-purple hover:underline">${authorData.email}</a>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Website -->
                    ${authorData.website ? `
                    <div class="flex items-center gap-3">
                        <i data-lucide="globe" class="w-4 h-4 text-slate-400"></i>
                        <div>
                            <div class="text-xs text-slate-400">Web Sitesi</div>
                            <a href="${authorData.website.startsWith('http') ? authorData.website : 'https://' + authorData.website}" target="_blank" class="text-sm font-medium text-mlab-purple hover:underline">${authorData.website}</a>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Sector -->
                    ${authorData.sector ? `
                    <div class="flex items-center gap-3">
                        <i data-lucide="briefcase" class="w-4 h-4 text-slate-400"></i>
                        <div>
                            <div class="text-xs text-slate-400">Sektör</div>
                            <div class="text-sm font-medium text-slate-700">${sectorLabels[authorData.sector] || authorData.sector}</div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Description -->
                    ${authorData.description ? `
                    <div class="pt-3 border-t border-slate-100">
                        <div class="text-xs text-slate-400 mb-1">Hakkında</div>
                        <p class="text-sm text-slate-600 leading-relaxed">${authorData.description}</p>
                    </div>
                    ` : ''}
                </div>
            `;

            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeUserProfileModal() {
            document.getElementById('user-profile-modal').classList.add('hidden');
        }

        // Büyük Zorluklar (Grand Challenges)
        const challengeLabels = {
            'barinma': 'Uygun Fiyatlı Barınma',
            'hareketlilik': 'Sürdürülebilir Hareketlilik',
            'afet': 'Afetlere Dirençlilik',
            'gida': 'Sağlıklı Gıda',
            'saglik': 'Sağlık ve Esenlik',
            'egitim': 'Eğitimli Nesiller',
            'is': 'İnsana Yakışır İş',
            'inovasyon': 'İnovasyon Üretimi',
            'kultur': 'Kültür ve Kapsayıcılık',
            'dongusal': 'Döngüsel Metabolizma'
        };
        // For backward compatibility
        const sectorLabels = challengeLabels;

        // Load posts
        async function loadPosts() {
            try {
                const firebaseReady = await window.firebaseHelpers.initializeFirebase();

                if (!firebaseReady) {
                    // Fallback to localStorage
                    if (!localStorage.getItem('portal_posts')) {
                        localStorage.setItem('portal_posts', JSON.stringify([
                            {
                                id: 1,
                                post_type: 'destek_talebi',
                                title: 'Güneş Enerjisi Santral Kurulumu için Teknik Danışmanlık',
                                description: 'Belediyemiz hizmet binalarına güneş enerjisi santrali kurulumu planlanmaktadır. Bu konuda deneyimli firmalardan teknik danışmanlık ve fizibilite çalışması desteği aranmaktadır.',
                                sector: 'enerji',
                                tags: ['güneş enerjisi', 'yenilenebilir', 'GES'],
                                author: { name: 'Konak Belediyesi', category: 'belediye' },
                                created_at: '2026-01-07T10:00:00Z'
                            },
                            {
                                id: 2,
                                post_type: 'uzmanlik_sunumu',
                                title: 'Akıllı Ulaşım ve Trafik Yönetim Sistemleri',
                                description: 'Şirketimiz, akıllı şehir uygulamaları kapsamında trafik yönetimi, toplu taşıma optimizasyonu ve mobil ulaşım çözümleri konularında hizmet sunmaktadır.',
                                sector: 'ulasim',
                                tags: ['akıllı şehir', 'trafik', 'IoT'],
                                author: { name: 'SmartCity Solutions', category: 'ozel_sektor' },
                                created_at: '2026-01-06T14:30:00Z'
                            }
                        ]));
                    }
                    allPosts = JSON.parse(localStorage.getItem('portal_posts') || '[]');
                    renderPosts();
                    return;
                }

                const { db, collection, getDocs, query, orderBy } = window.firebaseDb;
                const postsRef = collection(db, 'posts');
                const q = query(postsRef, orderBy('created_at', 'desc'));
                const snapshot = await getDocs(q);

                allPosts = [];
                snapshot.forEach(doc => {
                    allPosts.push({ id: doc.id, ...doc.data() });
                });

                // Also save to localStorage for offline access
                localStorage.setItem('portal_posts', JSON.stringify(allPosts));
                renderPosts();
            } catch (error) {
                console.error('Postlar yüklenirken hata:', error);
                // Fallback to localStorage
                allPosts = JSON.parse(localStorage.getItem('portal_posts') || '[]');
                renderPosts();
            }
        }

        function renderPosts() {
            const container = document.getElementById('posts-container');
            const emptyState = document.getElementById('empty-state');

            // Update stats
            document.getElementById('stat-requests').textContent = allPosts.filter(p => p.post_type ===
                'destek_talebi').length;
            document.getElementById('stat-offers').textContent = allPosts.filter(p => p.post_type ===
                'uzmanlik_sunumu').length;
            document.getElementById('stat-belediye').textContent = allPosts.filter(p => p.author?.category ===
                'belediye').length;
            document.getElementById('stat-ozel').textContent = allPosts.filter(p => p.author?.category ===
                'ozel_sektor').length;

            if (allPosts.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            container.innerHTML = allPosts.map(post => {
                const isRequest = post.post_type === 'destek_talebi';
                const typeColor = isRequest ? 'cyan' : 'orange';
                const typeIcon = isRequest ? 'message-square-plus' : 'sparkles';
                const typeLabel = isRequest ? 'Destek Talebi' : 'Uzmanlık Bildirisi';
                const categoryIcon = post.author?.category === 'belediye' ? 'landmark' : 'building-2';
                const date = formatDate(post.created_at);
                const authorDisplay = post.author?.contact_name
                    ? `${post.author.name} - ${post.author.contact_name}`
                    : post.author?.name || 'Bilinmiyor';

                return `
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow overflow-hidden">
            <!-- Post Header: Author, Date & Tags -->
            <div class="px-6 py-4 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br ${isRequest ? 'from-mlab-cyan to-blue-500' : 'from-mlab-orange to-amber-500'} flex items-center justify-center shadow-md cursor-pointer" onclick="showUserProfile('${post.author_id || post.id}', ${JSON.stringify(post.author).replace(/"/g, '&quot;')})">
                            <i data-lucide="${categoryIcon}" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-mlab-navy text-sm cursor-pointer hover:text-mlab-purple transition-colors" onclick="showUserProfile('${post.author_id || post.id}', ${JSON.stringify(post.author).replace(/"/g, '&quot;')})">${authorDisplay}</div>
                            <div class="text-xs text-slate-400">${date}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="px-2.5 py-1 rounded bg-slate-100 text-slate-600 text-xs font-medium border border-slate-200">${sectorLabels[post.sector] || post.sector}</span>
                        <span class="px-3 py-1 rounded-full bg-mlab-${typeColor}/10 text-mlab-${typeColor} text-xs font-semibold border border-mlab-${typeColor}/10">${typeLabel}</span>
                    </div>
                </div>
            </div>
            
            <!-- Post Content -->
            <div class="px-6 py-5">
                <!-- Title -->
                <h3 class="font-bold text-lg text-mlab-navy mb-2">${post.title}</h3>
                
                
                <!-- Description -->
                <p class="text-slate-600 text-sm leading-relaxed">${post.description}</p>
                
                <!-- Footer Content: Files & Reply Button -->
                <div class="flex flex-wrap items-end justify-between gap-y-2 mt-3">
                    <!-- Attached Files -->
                    <div class="flex flex-wrap gap-2">
                        ${post.files && post.files.length > 0 ? post.files.map(file => `
                            <a href="${file.url}" target="_blank" download="${file.name}"
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-slate-50 hover:bg-mlab-purple/5 border border-slate-200 hover:border-mlab-purple/30 text-slate-700 hover:text-mlab-purple text-xs font-medium rounded-lg transition-all">
                                <i data-lucide="${getFileIconType(file.type)}" class="w-3.5 h-3.5 text-slate-400"></i>
                                ${file.name}
                                <i data-lucide="download" class="w-3 h-3 opacity-50 ml-1"></i>
                            </a>
                        `).join('') : ''}
                    </div>

                    <!-- Reply Button -->
                    <button onclick="toggleReplyBox('${post.id}')"
                        class="px-3.5 py-1.5 bg-mlab-purple/10 text-mlab-purple text-xs font-semibold rounded-lg hover:bg-mlab-purple hover:text-white transition-all flex items-center gap-1.5 ml-auto">
                        <i data-lucide="message-circle" class="w-3.5 h-3.5"></i>
                        Yanıtla
                    </button>
                </div>
            </div>

            <!-- Separator Line -->
            <div class="border-b border-slate-100 mx-6 mb-2"></div>

            <!-- Reply Input (hidden by default) -->
            <div id="reply-box-${post.id}" class="hidden px-6 py-4">
                <div class="space-y-2">
                    <div class="flex gap-2">
                        <input type="text" id="comment-input-${post.id}" placeholder="Yanıtınızı yazın..."
                            class="flex-grow bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-mlab-purple/10 focus:border-mlab-purple/30"
                            onkeypress="if(event.key==='Enter' && !event.shiftKey){submitInlineComment('${post.id}');event.preventDefault();}">
                        <label for="comment-file-${post.id}" class="px-3 py-2 bg-white border border-slate-200 text-slate-500 text-sm rounded-lg hover:bg-slate-50 hover:text-mlab-purple cursor-pointer flex items-center gap-1 transition-colors" title="Dosya ekle">
                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                        </label>
                        <input type="file" id="comment-file-${post.id}" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif" onchange="handleCommentFileSelect(event, '${post.id}')">
                        <button onclick="submitInlineComment('${post.id}')"
                            class="px-3 py-2 bg-mlab-navy text-white text-sm font-medium rounded-lg hover:bg-mlab-purple transition-colors shadow-sm">
                            Gönder
                        </button>
                    </div>
                    <div id="comment-file-display-${post.id}" class="hidden text-xs bg-slate-50 border border-slate-200 rounded px-2 py-1.5 flex items-center justify-between w-fit max-w-full">
                        <span id="comment-file-name-${post.id}" class="truncate text-slate-600 mr-2"></span>
                        <button onclick="removeCommentFile('${post.id}')" class="text-slate-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>
                </div>
            </div>

            <!-- Comments (compact style) -->
            <div id="comments-${post.id}" class="px-6 pb-6 space-y-0">
                <!-- Comments will be loaded here -->
            </div>
        </div>
        `;
            }).join('');

            lucide.createIcons();
            allPosts.forEach(post => loadInlineComments(post.id));
        }

        function toggleReplyBox(postId) {
            const box = document.getElementById(`reply-box-${postId}`);
            box.classList.toggle('hidden');
            if (!box.classList.contains('hidden')) {
                document.getElementById(`comment-input-${postId}`).focus();
            }
        }

        async function loadInlineComments(postId) {
            const container = document.getElementById(`comments-${postId}`);
            if (!container) return;

            try {
                const firebaseReady = await window.firebaseHelpers.initializeFirebase();
                let comments = [];

                if (!firebaseReady) {
                    const allComments = JSON.parse(localStorage.getItem('portal_comments') || '{}');
                    comments = allComments[postId] || [];
                } else {
                    const { db, collection, getDocs, query, orderBy } = window.firebaseDb;
                    const commentsRef = collection(db, 'posts', String(postId), 'comments');
                    const q = query(commentsRef, orderBy('created_at', 'asc'));
                    const snapshot = await getDocs(q);
                    snapshot.forEach(doc => {
                        comments.push({ id: doc.id, ...doc.data() });
                    });
                }

                if (comments.length === 0) {
                    container.innerHTML = '';
                } else {
                    container.innerHTML = comments.map(comment => {
                        let dateStr = '';
                        if (comment.created_at) {
                            const date = comment.created_at.toDate ? comment.created_at.toDate() : new Date(comment.created_at);
                            dateStr = date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' }) + ' ' +
                                date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                        }
                        const authorDisplay = comment.author?.contact_name
                            ? `${comment.author.name} - ${comment.author.contact_name}`
                            : comment.author?.name || 'Anonim';

                        // File attachment display
                        let fileHtml = '';
                        if (comment.file && comment.file.url) {
                            const iconType = getFileIconType(comment.file.type || '');
                            fileHtml = `
                                <div class="mt-2 text-left">
                                    <a href="${comment.file.url}" target="_blank" download="${comment.file.name}"
                                        class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-white border border-slate-200 hover:border-mlab-purple/30 text-slate-700 hover:text-mlab-purple text-xs font-medium rounded-lg transition-colors shadow-sm w-fit max-w-full">
                                        <i data-lucide="${iconType}" class="w-3.5 h-3.5 text-slate-400 shrink-0"></i>
                                        <span class="truncate">${comment.file.name}</span>
                                        <i data-lucide="download" class="w-3.5 h-3.5 opacity-50 ml-1 shrink-0"></i>
                                    </a>
                                </div>
                            `;
                        }

                        // Check if current user is author (for styling)
                        const isAuthor = comment.author_id === currentUser?.uid;

                        return `
                        <div class="relative pl-4 sm:pl-6 py-3 group">
                            <!-- Connector Line -->
                            <div class="absolute left-0 top-0 bottom-0 w-px bg-slate-200"></div>
                            <div class="absolute left-[-4.5px] top-5 w-2.5 h-2.5 rounded-full border-2 border-mlab-purple bg-white"></div>
                            
                            <div class="flex flex-col gap-1.5">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-semibold text-mlab-navy">${authorDisplay}</span>
                                    <span class="text-xs text-slate-400">${dateStr}</span>
                                </div>
                                <div class="text-sm text-slate-700 bg-slate-50 p-3 rounded-lg border border-slate-100/60">
                                    <p class="leading-relaxed whitespace-pre-wrap mb-0.5">${comment.message || ''}</p>
                                    ${fileHtml}
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                }
                lucide.createIcons();
            } catch (error) {
                console.error('Yorumlar yüklenirken hata:', error);
                container.innerHTML = '';
            }
        }

        async function submitInlineComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const message = input.value.trim();

            if (!message && !commentFiles[postId]) {
                alert('Lütfen bir yanıt yazın veya dosya ekleyin.');
                return;
            }

            try {
                const firebaseReady = await window.firebaseHelpers.initializeFirebase();

                // Upload comment file if exists
                let uploadedFile = null;
                if (commentFiles[postId] && firebaseReady && window.firebaseStorage) {
                    const { storage, ref, uploadBytes, getDownloadURL } = window.firebaseStorage;
                    const file = commentFiles[postId];
                    const commentId = Date.now().toString();
                    const fileName = `${commentId}_${file.name}`;
                    const storageRef = ref(storage, `comments/${postId}/${fileName}`);

                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);

                    uploadedFile = {
                        name: file.name,
                        url: url,
                        size: file.size,
                        type: file.type
                    };
                }

                const newComment = {
                    message: message || '',
                    file: uploadedFile,
                    author: {
                        name: currentUser.org_name,
                        contact_name: currentUser.contact_name,
                        contact_title: currentUser.contact_title,
                        email: currentUser.email,
                        category: currentUser.org_type || currentUser.category
                    },
                    author_id: currentUser.uid || currentUser.id
                };

                if (!firebaseReady) {
                    const allComments = JSON.parse(localStorage.getItem('portal_comments') || '{}');
                    if (!allComments[postId]) {
                        allComments[postId] = [];
                    }
                    newComment.id = Date.now();
                    newComment.created_at = new Date().toISOString();
                    allComments[postId].push(newComment);
                    localStorage.setItem('portal_comments', JSON.stringify(allComments));
                } else {
                    const { db, collection, doc, setDoc, serverTimestamp, updateDoc, increment } = window.firebaseDb;
                    const commentId = Date.now().toString();
                    await setDoc(doc(db, 'posts', String(postId), 'comments', commentId), {
                        ...newComment,
                        created_at: serverTimestamp()
                    });
                    try {
                        await updateDoc(doc(db, 'posts', String(postId)), {
                            responses_count: increment(1)
                        });
                    } catch (e) { }
                }

                input.value = '';
                removeCommentFile(postId);
                await loadInlineComments(postId);
            } catch (error) {
                console.error('Yorum gönderme hatası:', error);
                alert('Yanıt gönderilemedi.');
            }
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else {
                return '';
            }
            return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' }) + ' ' + date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
        }

        let currentPostId = null;

        async function openPostDetail(id) {
            const post = allPosts.find(p => p.id === id || p.id === parseInt(id) || p.id === String(id));
            if (!post) return;

            currentPostId = post.id;
            const isRequest = post.post_type === 'destek_talebi';
            const typeLabel = isRequest ? 'Destek Talebi' : 'Uzmanlık Bildirisi';
            const categoryLabel = post.author?.category === 'belediye' ? 'Belediye' : 'Özel Sektör';

            let dateStr = '';
            if (post.created_at) {
                const date = post.created_at.toDate ? post.created_at.toDate() : new Date(post.created_at);
                dateStr = date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
            }

            document.getElementById('detail-title').textContent = post.title;
            document.getElementById('detail-content').innerHTML = `
        <div class="space-y-6">
            <div class="flex flex-wrap gap-2">
                <span
                    class="px-3 py-1 rounded-full bg-mlab-${isRequest ? 'cyan' : 'orange'}/10 text-mlab-${isRequest ? 'cyan' : 'orange'} text-sm font-semibold">${typeLabel}</span>
                <span
                    class="px-3 py-1 rounded-full bg-slate-100 text-slate-600 text-sm font-medium">${sectorLabels[post.sector]
                || post.sector}</span>
            </div>

            <div class="prose prose-slate max-w-none">
                <p class="text-slate-700 leading-relaxed whitespace-pre-line">${post.description}</p>
            </div>

            ${post.tags && post.tags.length > 0 ? `
            <div class="flex flex-wrap gap-2">
                ${post.tags.map(tag => `<span
                    class="px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded-lg">#${tag}</span>`).join('')}
            </div>
            ` : ''}

            <div class="flex items-center justify-between bg-slate-50 rounded-xl p-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-mlab-purple/10 flex items-center justify-center">
                        <i data-lucide="${post.author?.category === 'belediye' ? 'landmark' : 'building-2'}"
                            class="w-5 h-5 text-mlab-purple"></i>
                    </div>
                    <div>
                        <div class="font-semibold text-mlab-navy">${post.author?.name || 'Bilinmiyor'}</div>
                        <div class="text-xs text-slate-500">${categoryLabel} • ${dateStr}</div>
                    </div>
                </div>
            </div>

            <hr class="border-slate-100">

            <!-- Comments Section -->
            <div>
                <h3 class="font-semibold text-mlab-navy mb-4 flex items-center gap-2">
                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                    Yanıtlar
                    <span id="comments-count" class="text-sm font-normal text-slate-500">(yükleniyor...)</span>
                </h3>

                <!-- Comment Input -->
                <div class="bg-slate-50 rounded-xl p-4 mb-4">
                    <textarea id="comment-input" rows="3" placeholder="Yanıtınızı yazın..."
                        class="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all resize-none text-sm"></textarea>
                    <div class="flex justify-end mt-3">
                        <button onclick="submitComment()" id="submit-comment-btn"
                            class="px-5 py-2 bg-mlab-navy text-white font-medium rounded-lg hover:bg-mlab-purple transition-colors text-sm flex items-center gap-2">
                            <i data-lucide="send" class="w-4 h-4"></i>
                            Gönder
                        </button>
                    </div>
                </div>

                <!-- Comments List -->
                <div id="comments-list" class="space-y-3">
                    <div class="text-center py-4 text-slate-400 text-sm">
                        <i data-lucide="loader-2" class="w-5 h-5 animate-spin inline"></i>
                        Yanıtlar yükleniyor...
                    </div>
                </div>
            </div>
        </div>
        `;
            lucide.createIcons();
            document.getElementById('post-detail-modal').classList.remove('hidden');

            // Load comments
            await loadComments(post.id);
        }

        async function loadComments(postId) {
            const commentsList = document.getElementById('comments-list');
            const commentsCount = document.getElementById('comments-count');

            try {
                const firebaseReady = await window.firebaseHelpers.initializeFirebase();

                if (!firebaseReady) {
                    // localStorage fallback
                    const allComments = JSON.parse(localStorage.getItem('portal_comments') || '{}');
                    const comments = allComments[postId] || [];
                    renderComments(comments);
                    return;
                }

                const { db, collection, getDocs, query, orderBy } = window.firebaseDb;
                const commentsRef = collection(db, 'posts', String(postId), 'comments');
                const q = query(commentsRef, orderBy('created_at', 'asc'));
                const snapshot = await getDocs(q);

                const comments = [];
                snapshot.forEach(doc => {
                    comments.push({ id: doc.id, ...doc.data() });
                });

                renderComments(comments);
            } catch (error) {
                console.error('Yorumlar yüklenirken hata:', error);
                commentsList.innerHTML = '<div class="text-center py-4 text-red-500 text-sm">Yorumlar yüklenemedi.</div>';
            }
        }

        function renderComments(comments) {
            const commentsList = document.getElementById('comments-list');
            const commentsCount = document.getElementById('comments-count');

            commentsCount.textContent = `(${comments.length})`;

            if (comments.length === 0) {
                commentsList.innerHTML = `
        <div class="text-center py-8 text-slate-400 text-sm">
            <i data-lucide="message-circle" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
            <p>Henüz yanıt yok. İlk yanıtı siz yazın!</p>
        </div>
        `;
                lucide.createIcons();
                return;
            }

            commentsList.innerHTML = comments.map(comment => {
                const categoryIcon = comment.author?.category === 'belediye' ? 'landmark' : 'building-2';
                let dateStr = '';
                if (comment.created_at) {
                    const date = comment.created_at.toDate ? comment.created_at.toDate() : new Date(comment.created_at);
                    dateStr = date.toLocaleDateString('tr-TR', {
                        day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                    });
                }
                const authorDisplay = comment.author?.contact_name
                    ? `${comment.author.name} - ${comment.author.contact_name}`
                    : comment.author?.name || 'Anonim';

                return `
        <div class="bg-white border border-slate-100 rounded-xl p-4">
            <div class="flex items-start gap-3">
                <div
                    class="w-8 h-8 rounded-full ${comment.author?.category === 'belediye' ? 'bg-mlab-navy/10' : 'bg-mlab-orange/10'} flex items-center justify-center flex-shrink-0">
                    <i data-lucide="${categoryIcon}"
                        class="w-4 h-4 ${comment.author?.category === 'belediye' ? 'text-mlab-navy' : 'text-mlab-orange'}"></i>
                </div>
                <div class="flex-grow min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-semibold text-mlab-navy text-sm">${authorDisplay}</span>
                        <span class="text-xs text-slate-400">${dateStr}</span>
                    </div>
                    <p class="text-slate-700 text-sm whitespace-pre-line">${comment.message}</p>
                </div>
            </div>
        </div>
        `;
            }).join('');

            lucide.createIcons();
        }

        async function submitComment() {
            const input = document.getElementById('comment-input');
            const message = input.value.trim();

            if (!message) {
                alert('Lütfen bir yanıt yazın.');
                return;
            }

            const btn = document.getElementById('submit-comment-btn');
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Gönderiliyor...';
            lucide.createIcons();

            const newComment = {
                message: message,
                author: {
                    name: currentUser.org_name,
                    contact_name: currentUser.contact_name,
                    contact_title: currentUser.contact_title,
                    email: currentUser.email,
                    category: currentUser.org_type || currentUser.category
                },
                author_id: currentUser.uid || currentUser.id
            };

            try {
                const firebaseReady = await window.firebaseHelpers.initializeFirebase();

                if (!firebaseReady) {
                    // localStorage fallback
                    const allComments = JSON.parse(localStorage.getItem('portal_comments') || '{}');
                    if (!allComments[currentPostId]) {
                        allComments[currentPostId] = [];
                    }
                    newComment.id = Date.now();
                    newComment.created_at = new Date().toISOString();
                    allComments[currentPostId].push(newComment);
                    localStorage.setItem('portal_comments', JSON.stringify(allComments));
                } else {
                    const { db, collection, doc, setDoc, serverTimestamp, updateDoc, increment } = window.firebaseDb;
                    const commentId = Date.now().toString();
                    await setDoc(doc(db, 'posts', String(currentPostId), 'comments', commentId), {
                        ...newComment,
                        created_at: serverTimestamp()
                    });

                    // Update post's response count (optional)
                    try {
                        await updateDoc(doc(db, 'posts', String(currentPostId)), {
                            responses_count: increment(1)
                        });
                    } catch (e) { /* ignore if increment fails */ }
                }

                input.value = '';
                await loadComments(currentPostId);

            } catch (error) {
                console.error('Yorum gönderme hatası:', error);
                alert('Yorum gönderilemedi. Lütfen tekrar deneyin.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> Gönder';
                lucide.createIcons();
            }
        }

        function closePostDetailModal() {
            document.getElementById('post-detail-modal').classList.add('hidden');
        }

        // New Post Modal
        document.getElementById('new-post-btn').addEventListener('click', openNewPostModal);
        document.getElementById('mobile-new-post-btn').addEventListener('click', openNewPostModal);

        function openNewPostModal() {
            document.getElementById('new-post-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeNewPostModal() {
            document.getElementById('new-post-modal').classList.add('hidden');
            document.getElementById('new-post-form').reset();
        }

        async function submitNewPost() {
            const form = document.getElementById('new-post-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const postId = Date.now().toString();

            // Show loading state
            const submitBtn = document.querySelector('#new-post-modal button[onclick="submitNewPost()"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin inline mr-2"></i>Yükleniyor...';
            submitBtn.disabled = true;

            try {
                // Ensure Firebase is initialized before upload
                const firebaseReady = await window.firebaseHelpers.initializeFirebase();

                // Upload single file if selected
                let uploadedFile = null;
                if (selectedFile && firebaseReady && window.firebaseStorage) {
                    const { storage, ref, uploadBytes, getDownloadURL } = window.firebaseStorage;
                    const fileName = `${Date.now()}_${selectedFile.name}`;
                    const storageRef = ref(storage, `posts/${postId}/${fileName}`);

                    await uploadBytes(storageRef, selectedFile);
                    const url = await getDownloadURL(storageRef);

                    uploadedFile = {
                        name: selectedFile.name,
                        url: url,
                        size: selectedFile.size,
                        type: selectedFile.type
                    };
                }

                const newPost = {
                    post_type: data.post_type,
                    title: data.title,
                    description: data.description,
                    sector: data.sector,
                    tags: data.tags ? data.tags.split(',').map(t => t.trim()).filter(t => t) : [],
                    files: uploadedFile ? [uploadedFile] : [],
                    author: {
                        name: currentUser.org_name,
                        contact_name: currentUser.contact_name,
                        contact_title: currentUser.contact_title,
                        email: currentUser.email,
                        category: currentUser.org_type || currentUser.category
                    },
                    author_id: currentUser.uid || currentUser.id,
                    status: 'active',
                    responses_count: 0
                };

                // firebaseReady already initialized above

                if (!firebaseReady) {
                    // localStorage fallback
                    const posts = JSON.parse(localStorage.getItem('portal_posts') || '[]');
                    newPost.id = postId;
                    newPost.created_at = new Date().toISOString();
                    posts.push(newPost);
                    localStorage.setItem('portal_posts', JSON.stringify(posts));
                } else {
                    const { db, collection, doc, setDoc, serverTimestamp } = window.firebaseDb;
                    await setDoc(doc(db, 'posts', postId), {
                        ...newPost,
                        created_at: serverTimestamp()
                    });
                }

                // Clear selected file
                selectedFile = null;
                removeSelectedFile();

                closeNewPostModal();
                await loadPosts();
            } catch (error) {
                console.error('Post oluşturma hatası:', error);
                alert('Post oluşturulurken bir hata oluştu.');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // --- EXPERT MODAL LOGIC ---
        function openExpertModal() {
            document.getElementById('expert-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Auto-fill some fields if possible
            if (currentUser) {
                document.querySelector('[name="fullName"]').value = currentUser.contact_name || '';
                document.querySelector('[name="email"]').value = currentUser.email || '';
                document.querySelector('[name="organization"]').value = currentUser.org_name || '';
                document.querySelector('[name="title"]').value = currentUser.contact_title || '';
                document.querySelector('[name="phone"]').value = currentUser.phone || '';
            }
        }

        function closeExpertModal() {
            document.getElementById('expert-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function openCocModal() {
            document.getElementById('coc-modal').classList.remove('hidden');
        }

        function closeCocModal() {
            document.getElementById('coc-modal').classList.add('hidden');
        }

        function acceptCoc() {
            const cocCheckbox = document.getElementById('coc-checkbox');
            const submitBtn = document.getElementById('expert-submit-btn');

            cocCheckbox.disabled = false;
            cocCheckbox.checked = true;
            submitBtn.disabled = false;
            closeCocModal();
        }

        document.getElementById('coc-checkbox').addEventListener('change', (e) => {
            document.getElementById('expert-submit-btn').disabled = !e.target.checked;
        });

        // Expert Form Submission
        document.getElementById('expert-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('expert-submit-btn');
            const originalText = submitBtn.innerHTML;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Gönderiliyor...';
            lucide.createIcons();

            try {
                // Initialize Firebase if not already
                if (!window.firebaseDb) await window.firebaseHelpers.initializeFirebase();
                const { db, collection, doc, setDoc, serverTimestamp } = window.firebaseDb;

                const formData = {
                    fullName: this.querySelector('[name="fullName"]').value,
                    profession: this.querySelector('[name="profession"]').value,
                    organization: this.querySelector('[name="organization"]').value,
                    title: this.querySelector('[name="title"]').value,
                    email: this.querySelector('[name="email"]').value,
                    phone: this.querySelector('[name="phone"]').value,
                    expertiseArea: this.querySelector('[name="expertiseArea"]').value,
                    expertiseDetails: this.querySelector('[name="expertiseDetails"]').value,
                    education: this.querySelector('[name="education"]').value,
                    ethicsAccepted: true,
                    status: 'pending',
                    createdAt: serverTimestamp(),
                    userId: currentUser?.uid || null // Link to portal user if available
                };

                const docId = `expert_${Date.now()}`;
                await setDoc(doc(db, 'expert_applications', docId), formData);

                // Success State
                alert('Başvurunuz başarıyla alındı! Değerlendirme sonucunda sizinle iletişime geçilecektir.');
                this.reset();
                closeExpertModal();

            } catch (error) {
                console.error('Uzman başvuru hatası:', error);
                alert('Bir hata oluştu. Lütfen tekrar deneyin.');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        function applyFilters() {
            // Check if current user is expert (if we want to hide/show things, but here just robust check)
            if (!allPosts) return;

            // Get filter values
            const postType = document.querySelector('input[name="post_type"]:checked')?.value || 'all';
            const belediyeChecked = document.querySelector('input[name="category"][value="belediye"]')?.checked;
            const ozelSektorChecked = document.querySelector('input[name="category"][value="ozel_sektor"]')?.checked;
            const sectorFilter = document.getElementById('sector-filter')?.value || 'all';

            // Filter posts
            let filtered = [...allPosts];

            // Filter by post type
            if (postType !== 'all') {
                filtered = filtered.filter(post => post.post_type === postType);
            }

            // Filter by category (author type)
            const selectedCategories = [];
            if (belediyeChecked) selectedCategories.push('belediye');
            if (ozelSektorChecked) selectedCategories.push('ozel_sektor');

            if (selectedCategories.length > 0 && selectedCategories.length < 2) {
                filtered = filtered.filter(post =>
                    selectedCategories.includes(post.author?.category));
            }

            // Filter by sector (Büyük Zorluk)
            if (sectorFilter !== 'all') {
                filtered = filtered.filter(post => post.sector === sectorFilter);
            }

            // Re-render with filtered posts
            renderFilteredPosts(filtered);
        }

        function renderFilteredPosts(posts) {
            const container = document.getElementById('posts-container');
            const emptyState = document.getElementById('empty-state');

            if (posts.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            const sectorLabels = {
                'barinma': 'Uygun Fiyatlı Barınma',
                'hareketlilik': 'Sürdürülebilir Hareketlilik',
                'afet': 'Afetlere Dirençlilik',
                'gida': 'Sağlıklı Gıda',
                'saglik': 'Sağlık ve Esenlik',
                'egitim': 'Eğitimli Nesiller',
                'is': 'İnsana Yakışır İş',
                'inovasyon': 'İnovasyon Üretimi',
                'kultur': 'Kültür ve Kapsayıcılık',
                'dongusal': 'Döngüsel Metabolizma'
            };

            container.innerHTML = posts.map(post => {
                const isRequest = post.post_type === 'destek_talebi';
                const typeColor = isRequest ? 'cyan' : 'orange';
                const typeLabel = isRequest ? 'Destek Talebi' : 'Uzmanlık Bildirisi';
                const categoryIcon = post.author?.category === 'belediye' ? 'landmark' : 'building-2';
                const date = formatDate(post.created_at);
                const authorDisplay = post.author?.contact_name
                    ? `${post.author.name} - ${post.author.contact_name}`
                    : post.author?.name || 'Bilinmiyor';

                return `
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hover:shadow-md transition-shadow">
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <span
                            class="px-3 py-1 rounded-full bg-mlab-${typeColor}/10 text-mlab-${typeColor} text-xs font-semibold">${typeLabel}</span>
                        <span
                            class="px-3 py-1 rounded-full bg-slate-100 text-slate-600 text-xs font-medium">${sectorLabels[post.sector]
                    || post.sector}</span>
                    </div>
                    <h3 class="font-bold text-lg text-mlab-navy mb-2">${post.title}</h3>
                    <p class="text-slate-600 text-sm mb-4 leading-relaxed">${post.description}</p>
                    <div class="flex items-center justify-between pt-3 border-t border-slate-100">
                        <div class="flex items-center gap-2 text-sm text-slate-500">
                            <i data-lucide="${categoryIcon}" class="w-4 h-4"></i>
                            <span class="font-medium">${authorDisplay}</span>
                            <span class="text-slate-300">•</span>
                            <span>${date}</span>
                        </div>
                        <button onclick="toggleReplyBox('${post.id}')"
                            class="px-4 py-2 bg-mlab-purple/10 text-mlab-purple text-sm font-semibold rounded-lg hover:bg-mlab-purple hover:text-white transition-all flex items-center gap-2">
                            <i data-lucide="message-circle" class="w-4 h-4"></i>
                            Yanıtla
                        </button>
                    </div>
                </div>
            </div>
            `;
            }).join('');

            lucide.createIcons();
        }

        // Initialize
        async function init() {
            const authenticated = await checkAuth();
            if (authenticated) {
                await loadPosts();
            }
        }

        init();
    </script>
</body>

</html>