<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil | M-LAB Portal</title>
    <link rel="icon" type="image/jpeg" href="mlab favicon.jpg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        mlab: {
                            navy: '#0a192f',
                            cyan: '#00d4ff',
                            purple: '#7c3aed',
                            dark: '#0f172a',
                            orange: '#ff7e67',
                            teal: '#0d9488'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="i18n.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";


        const firebaseConfig = {
            apiKey: "AIzaSyBwusBNSu5WXyjUDDb69VDGfg8NKfSfOXc",
            authDomain: "mlab-57ccc.firebaseapp.com",
            projectId: "mlab-57ccc",
            storageBucket: "mlab-57ccc.firebasestorage.app",
            messagingSenderId: "636480644814",
            appId: "1:636480644814:web:45957e4de027ebf5b5129f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);


        window.auth = auth;
        window.db = db;

        window.doc = doc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;

        window.signOut = signOut;

        // Define loadUserProfile function first
        async function loadUserProfile(userId) {
            // Helper function to fill form fields
            function fillFormWithData(data) {
                window.currentUserData = data;

                // Fill form fields
                document.getElementById('org_name').value = data.name || '';
                document.getElementById('website').value = data.website || '';
                document.getElementById('org_description').value = data.description || '';
                document.getElementById('contact_name').value = data.contact_name || '';
                document.getElementById('contact_title').value = data.contact_title || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('phone').value = data.phone || '';

                // Set category
                if (data.category === 'belediye') {
                    document.getElementById('cat-belediye').checked = true;
                } else {
                    document.getElementById('cat-ozel').checked = true;
                }

                // Set challenges
                const challenges = data.challenges || [];
                challenges.forEach(c => {
                    const checkbox = document.querySelector(`input[name="challenges"][value="${c}"]`);
                    if (checkbox) checkbox.checked = true;
                });

                // Update header
                document.getElementById('user-name').textContent = data.contact_name || data.name || 'Kullanıcı';
            }

            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    window.currentUserId = userId;
                    fillFormWithData(data);

                    // Also save to localStorage for offline access
                    const currentUser = JSON.parse(localStorage.getItem('portal_current_user') || '{}');
                    Object.assign(currentUser, data);
                    localStorage.setItem('portal_current_user', JSON.stringify(currentUser));
                }
            } catch (error) {
                console.error('Profil yüklenirken hata:', error);

                // Fallback to localStorage when offline
                const cachedUser = JSON.parse(localStorage.getItem('portal_current_user') || '{}');
                if (cachedUser && (cachedUser.name || cachedUser.email)) {
                    console.log('Çevrimdışı mod: localStorage verisi kullanılıyor');
                    fillFormWithData(cachedUser);
                }
            }
        }

        // Also expose to window for external access
        window.loadUserProfile = loadUserProfile;

        // Check auth from localStorage (same as dashboard)
        const currentUser = JSON.parse(localStorage.getItem('portal_current_user'));
        if (!currentUser) {
            window.location.href = 'portal-login.html';
        } else {
            // Load profile from Firestore using stored user ID
            const userId = currentUser.id || currentUser.uid;
            window.currentUserId = userId;
            loadUserProfile(userId);
        }

        window.logout = async function () {
            await signOut(auth);
            window.location.href = 'portal.html';
        };
    </script>
</head>

<body class="bg-slate-100 text-slate-800 antialiased min-h-screen" data-i18n-title="portal.nav.profile">
    <!-- NAVBAR -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-mlab-navy text-white shadow-xl">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-6">
                    <a href="/" class="flex items-center gap-3">
                        <img src="mlab-logo.png" alt="M-LAB" class="h-10 w-auto brightness-0 invert">
                    </a>
                    <span class="hidden md:inline text-white/50">|</span>
                    <span class="hidden md:inline text-sm font-medium text-mlab-cyan"
                        data-i18n="portal.nav.profile">Profil Ayarları</span>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Language Toggle -->
                    <div class="flex items-center gap-1 bg-white/10 rounded-full p-1 border border-white/10">
                        <button onclick="setLang('tr')"
                            class="lang-btn px-2 py-1 rounded-full text-xs font-bold transition-colors text-white"
                            data-lang="tr">TR</button>
                        <button onclick="setLang('en')"
                            class="lang-btn px-2 py-1 rounded-full text-xs font-medium transition-colors text-white/70 hover:text-white"
                            data-lang="en">EN</button>
                    </div>
                    <a href="portal-dashboard" class="text-sm text-white/70 hover:text-white transition-colors">
                        <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i>
                        <span data-i18n="portal.login.back_to_portal">Dashboard'a Dön</span>
                    </a>
                    <div class="relative" id="user-menu-container">
                        <button id="user-menu-btn"
                            class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-white/10 transition-colors">
                            <div
                                class="w-8 h-8 bg-mlab-purple rounded-full flex items-center justify-center overflow-hidden">
                                <i data-lucide="user" class="w-4 h-4 text-white"></i>
                            </div>
                            <span id="user-name" class="hidden md:inline text-sm font-medium">Kullanıcı</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="h-16"></div>

    <!-- MAIN CONTENT -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="max-w-3xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-2xl md:text-3xl font-bold text-mlab-navy mb-2" data-i18n="portal.nav.profile">Profil
                    Ayarları</h1>
                <p class="text-slate-600" data-i18n="portal.profile.subtitle">Kurum ve iletişim bilgilerinizi
                    güncelleyin.</p>
            </div>

            <!-- Profile Form -->
            <form id="profile-form" class="space-y-8">
                <!-- Profile Photo Section -->


                <!-- Organization Info -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h2 class="text-lg font-bold text-mlab-navy mb-4 flex items-center gap-2"
                        data-i18n="portal.register.org_info">
                        <i data-lucide="building" class="w-5 h-5 text-mlab-purple"></i>
                        Kurum Bilgileri
                    </h2>

                    <!-- Category -->
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-slate-700 mb-3"
                            data-i18n="portal.register.category">Kurum Kategorisi</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="relative cursor-pointer">
                                <input type="radio" id="cat-belediye" name="category" value="belediye"
                                    class="peer sr-only">
                                <div
                                    class="p-4 rounded-xl border-2 border-slate-200 peer-checked:border-mlab-navy peer-checked:bg-mlab-navy/5 transition-all hover:border-slate-300">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-10 h-10 rounded-lg bg-mlab-navy/10 flex items-center justify-center">
                                            <i data-lucide="landmark" class="w-5 h-5 text-mlab-navy"></i>
                                        </div>
                                        <div class="font-semibold text-mlab-navy"
                                            data-i18n="portal.filters.municipality">Belediye</div>
                                    </div>
                                </div>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" id="cat-ozel" name="category" value="ozel_sektor"
                                    class="peer sr-only">
                                <div
                                    class="p-4 rounded-xl border-2 border-slate-200 peer-checked:border-mlab-orange peer-checked:bg-mlab-orange/5 transition-all hover:border-slate-300">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-10 h-10 rounded-lg bg-mlab-orange/10 flex items-center justify-center">
                                            <i data-lucide="building-2" class="w-5 h-5 text-mlab-orange"></i>
                                        </div>
                                        <div class="font-semibold text-mlab-navy" data-i18n="portal.filters.private">
                                            Özel Sektör</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2"
                                data-i18n="portal.register.org_name">Kurum Adı</label>
                            <input type="text" id="org_name" name="org_name"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2"
                                data-i18n="portal.register.website">Web Sitesi</label>
                            <input type="text" id="website" name="website"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2"
                                data-i18n="portal.register.org_desc">Kurum Açıklaması</label>
                            <textarea id="org_description" name="org_description" rows="3"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all resize-none"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Büyük Zorluklar -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h2 class="text-lg font-bold text-mlab-navy mb-4 flex items-center gap-2"
                        data-i18n="nav.challenges">
                        <i data-lucide="target" class="w-5 h-5 text-mlab-purple"></i>
                        Büyük Zorluklar
                    </h2>
                    <p class="text-sm text-slate-600 mb-4" data-i18n="portal.register.challenges_label">Kurumunuz hangi
                        Büyük Zorluklar kapsamında katkı sunabilir?
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <label
                            class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 cursor-pointer transition">
                            <input type="checkbox" name="challenges" value="barinma"
                                class="w-4 h-4 rounded text-mlab-purple focus:ring-mlab-purple/50">
                            <span class="text-sm text-slate-700" data-i18n="challenge.1">Uygun Fiyatlı Barınma</span>
                        </label>
                        <label
                            class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 cursor-pointer transition">
                            <input type="checkbox" name="challenges" value="hareketlilik"
                                class="w-4 h-4 rounded text-mlab-purple focus:ring-mlab-purple/50">
                            <span class="text-sm text-slate-700" data-i18n="challenge.2">Sürdürülebilir
                                Hareketlilik</span>
                        </label>
                        <label
                            class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 cursor-pointer transition">
                            <input type="checkbox" name="challenges" value="afet"
                                class="w-4 h-4 rounded text-mlab-purple focus:ring-mlab-purple/50">
                            <span class="text-sm text-slate-700" data-i18n="challenge.3">Afetlere Dirençlilik</span>
                        </label>
                        <label
                            class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 cursor-pointer transition">
                            <input type="checkbox" name="challenges" value="gida"
                                class="w-4 h-4 rounded text-mlab-purple focus:ring-mlab-purple/50">
                            <span class="text-sm text-slate-700" data-i18n="challenge.4">Sağlıklı Gıda</span>
                        </label>
                        <label
                            class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 cursor-pointer transition">
                            <input type="checkbox" name="challenges" value="saglik"
                                class="w-4 h-4 rounded text-mlab-purple focus:ring-mlab-purple/50">
                            <span class="text-sm text-slate-700" data-i18n="challenge.5">Sağlık ve Esenlik</span>
                        </label>
                        <label
                            class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 cursor-pointer transition">
                            <input type="checkbox" name="challenges" value="egitim"
                                class="w-4 h-4 rounded text-mlab-purple focus:ring-mlab-purple/50">
                            <span class="text-sm text-slate-700" data-i18n="challenge.6">Eğitimli Nesiller</span>
                        </label>
                        <label
                            class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 cursor-pointer transition">
                            <input type="checkbox" name="challenges" value="is"
                                class="w-4 h-4 rounded text-mlab-purple focus:ring-mlab-purple/50">
                            <span class="text-sm text-slate-700" data-i18n="challenge.7">İnsana Yakışır İş</span>
                        </label>
                        <label
                            class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 cursor-pointer transition">
                            <input type="checkbox" name="challenges" value="inovasyon"
                                class="w-4 h-4 rounded text-mlab-purple focus:ring-mlab-purple/50">
                            <span class="text-sm text-slate-700" data-i18n="challenge.8">İnovasyon Üretimi</span>
                        </label>
                        <label
                            class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 cursor-pointer transition">
                            <input type="checkbox" name="challenges" value="kultur"
                                class="w-4 h-4 rounded text-mlab-purple focus:ring-mlab-purple/50">
                            <span class="text-sm text-slate-700" data-i18n="challenge.9">Kültür ve Kapsayıcılık</span>
                        </label>
                        <label
                            class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl hover:bg-slate-100 cursor-pointer transition">
                            <input type="checkbox" name="challenges" value="dongusal"
                                class="w-4 h-4 rounded text-mlab-purple focus:ring-mlab-purple/50">
                            <span class="text-sm text-slate-700" data-i18n="challenge.10">Döngüsel Metabolizma</span>
                        </label>
                    </div>
                </div>

                <!-- Contact Person -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h2 class="text-lg font-bold text-mlab-navy mb-4 flex items-center gap-2"
                        data-i18n="portal.register.contact_person">
                        <i data-lucide="user" class="w-5 h-5 text-mlab-purple"></i>
                        İletişim Kişisi
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2"
                                data-i18n="portal.register.contact_name">Ad Soyad</label>
                            <input type="text" id="contact_name" name="contact_name"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2"
                                data-i18n="portal.register.contact_title">Unvan / Pozisyon</label>
                            <input type="text" id="contact_title" name="contact_title"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2"
                                data-i18n="portal.login.email_auth">E-posta Adresi</label>
                            <input type="email" id="email" name="email" disabled
                                class="w-full bg-slate-100 border border-slate-200 rounded-xl px-4 py-3 text-slate-500 cursor-not-allowed">
                            <p class="text-xs text-slate-500 mt-1" data-i18n="portal.profile.email_fixed">E-posta
                                değiştirilemez</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2"
                                data-i18n="portal.register.phone">Telefon</label>
                            <input type="tel" id="phone" name="phone"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-mlab-cyan/50 focus:border-mlab-cyan transition-all">
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex items-center justify-between">
                    <a href="portal-dashboard" class="text-slate-600 hover:text-mlab-navy transition-colors">
                        <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i>
                        <span data-i18n="portal.common.cancel">Vazgeç</span>
                    </a>
                    <button type="submit"
                        class="px-8 py-3 bg-gradient-to-r from-mlab-purple to-mlab-navy text-white font-bold rounded-xl hover:shadow-xl hover:shadow-mlab-purple/20 transition-all duration-300 hover:-translate-y-0.5 flex items-center gap-2">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        <span data-i18n="portal.profile.save">Değişiklikleri Kaydet</span>
                    </button>
                </div>
            </form>

            <!-- Success Message -->
            <div id="success-message"
                class="hidden fixed bottom-6 right-6 bg-green-500 text-white px-6 py-3 rounded-xl shadow-xl flex items-center gap-2">
                <i data-lucide="check-circle" class="w-5 h-5"></i>
                <span data-i18n="portal.profile.success">Profil başarıyla güncellendi!</span>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();

        // Handle photo upload


        // Wait for DOM and Firebase to be ready
        document.addEventListener('DOMContentLoaded', () => {
            // Handle form submit
            document.getElementById('profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const userId = window.currentUserId;
                if (!userId) {
                    alert('Kullanıcı bulunamadı. Lütfen tekrar giriş yapın.');
                    return;
                }

                // Check if Firebase functions are available
                if (!window.updateDoc || !window.doc || !window.db) {
                    alert('Bağlantı hazır değil. Lütfen sayfayı yenileyip tekrar deneyin.');
                    console.error('Firebase functions not available:', { updateDoc: !!window.updateDoc, doc: !!window.doc, db: !!window.db });
                    return;
                }

                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                const savingText = t ? t('common.saving') : 'Kaydediliyor...';
                submitBtn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> ${savingText}`;
                submitBtn.disabled = true;

                const formData = {
                    name: document.getElementById('org_name').value,
                    website: document.getElementById('website').value,
                    description: document.getElementById('org_description').value,
                    contact_name: document.getElementById('contact_name').value,
                    contact_title: document.getElementById('contact_title').value,
                    phone: document.getElementById('phone').value,
                    category: document.querySelector('input[name="category"]:checked')?.value || 'belediye',
                    challenges: Array.from(document.querySelectorAll('input[name="challenges"]:checked')).map(cb => cb.value),
                    updatedAt: new Date()
                };

                try {
                    await window.updateDoc(window.doc(window.db, 'users', userId), formData);

                    // Also update localStorage
                    const currentUser = JSON.parse(localStorage.getItem('portal_current_user') || '{}');
                    Object.assign(currentUser, formData);
                    localStorage.setItem('portal_current_user', JSON.stringify(currentUser));

                    showSuccessMessage(t ? t('portal.profile.success') : 'Profil başarıyla güncellendi!');
                } catch (error) {
                    console.error('Profil güncellenirken hata:', error);
                    alert('Profil güncellenirken bir hata oluştu: ' + error.message);
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    lucide.createIcons();
                }
            });
        });

        function showSuccessMessage(message) {
            const el = document.getElementById('success-message');
            el.querySelector('span, i + *')?.remove();
            el.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5"></i> ${message}`;
            el.classList.remove('hidden');
            lucide.createIcons();
            setTimeout(() => {
                el.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>

</html>